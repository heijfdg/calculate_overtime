<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>åŠ ç­ç»Ÿè®¡å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f7;
      color: #1d1d1f;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      text-align: center;
      margin-bottom: 16px;
      color: #1d1d1f;
    }

    .description {
      text-align: center;
      font-size: 16px;
      color: #6e6e73;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    code {
      background: #e9e9eb;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 15px;
    }

    /* æ–‡ä»¶è¾“å…¥ç¾åŒ– */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 300px;
      margin-bottom: 12px;
    }

    #fileInput {
      width: 100%;
      height: 52px;
      opacity: 0;
      position: absolute;
      cursor: pointer;
    }

    .file-label {
      display: block;
      width: 100%;
      height: 52px;
      line-height: 52px;
      background: #007AFF;
      color: white;
      text-align: center;
      border-radius: 12px;
      font-size: 18px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .file-name {
      margin-top: 8px;
      font-size: 14px;
      color: #333;
      text-align: center;
      min-height: 18px;
    }

    /* æŒ‰é’®æ ·å¼ */
    .action-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 16px 0 24px;
    }

    .btn {
      flex: 1;
      min-width: 120px;
      max-width: 200px;
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: #007AFF;
      color: white;
      font-size: 18px;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:active {
      background: #0062cc;
    }

    .result {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      font-size: 16px;
      line-height: 1.6;
    }

    .result h2 {
      font-size: 20px;
      margin-top: 0;
      color: #007AFF;
    }

    .result p {
      margin: 12px 0;
      text-align: left;
    }

    hr {
      border: 0;
      border-top: 1px solid #e9e9eb;
      margin: 16px 0;
    }

    .total {
      font-weight: bold;
      font-size: 18px;
      color: #ff3b30;
      margin-top: 16px;
      display: block;
    }

    #installPrompt {
      text-align: center;
      font-size: 14px;
      color: #8e8e93;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“… åŠ ç­æ—¶é•¿è®¡ç®—å™¨</h1>
    <p class="description">é€‰æ‹©ä½ çš„ <code>overtime_log.json</code> æ–‡ä»¶<br>ï¼ˆæ”¯æŒä» iCloud æˆ–æœ¬åœ°ä¸Šä¼ ï¼‰</p>

    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <div class="file-input-wrapper">
      <input type="file" id="fileInput" accept=".json" onchange="showFileName()" />
      <label for="fileInput" class="file-label">ğŸ“ é€‰æ‹© JSON æ–‡ä»¶</label>
    </div>
    <div class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</div>

    <!-- æŒ‰é’®æ¨ªå‘æ’åˆ— -->
    <div class="action-buttons">
      <button class="btn" onclick="processFile()">è®¡ç®—åŠ ç­</button>
    </div>

    <div id="result"></div>

    <div id="installPrompt">
      ğŸ’¡ æç¤ºï¼šç‚¹å‡» Safari åˆ†äº«æŒ‰é’® â†’ â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ï¼Œ<br>ä»¥ååƒ App ä¸€æ ·å¿«é€Ÿä½¿ç”¨ï¼
    </div>
  </div>

  <script>
    // æ˜¾ç¤ºæ–‡ä»¶å
    function showFileName() {
      const input = document.getElementById('fileInput');
      const nameEl = document.getElementById('fileName');
      if (input.files.length > 0) {
        const name = input.files[0].name;
        nameEl.textContent = `å·²é€‰æ‹©ï¼š${name}`;
        nameEl.style.color = '#007AFF';
      } else {
        nameEl.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
        nameEl.style.color = '#333';
      }
    }

    // æ£€æµ‹ Safari
    if (/Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)) {
      document.getElementById('installPrompt').style.display = 'block';
    }

    function formatDuration(seconds) {
      if (seconds <= 0) return "0å°æ—¶0åˆ†é’Ÿ";
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
    }

    async function processFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!file) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ª JSON æ–‡ä»¶");
        return;
      }

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;

        const weekdayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
        let totalSeconds = 0;
        const details = [];

        for (const [dateStr, value] of Object.entries(data)) {
          if (!value?.entries) continue;

          const entries = Array.isArray(value.entries) ? value.entries : [value.entries];
          const datetimes = entries.map(ts => new Date(ts)).sort((a, b) => a - b);
          const recordDate = new Date(dateStr);

          const year = recordDate.getFullYear();
          const month = recordDate.getMonth() + 1;
          if (year !== currentYear || month !== currentMonth) continue;

          const weekdayIndex = recordDate.getDay();
          const isWeekend = weekdayIndex === 0 || weekdayIndex === 6;
          const timesStr = datetimes.map(d => d.toTimeString().slice(0, 5)).join(", ");

          let overtimeSec = 0;
          if (isWeekend) {
            const start = datetimes[0];
            const end = datetimes[datetimes.length - 1];
            overtimeSec = (end - start) / 1000;
          } else {
            const workEndTime = new Date(recordDate);
            workEndTime.setHours(17, 30, 0, 0);
            const latest = datetimes[datetimes.length - 1];
            if (latest > workEndTime) {
              overtimeSec = (latest - workEndTime) / 1000;
            }
          }

          if (overtimeSec > 0) totalSeconds += overtimeSec;

          details.push({
            date: dateStr,
            weekday: weekdayNames[weekdayIndex],
            times: timesStr,
            durationStr: formatDuration(overtimeSec)
          });
        }

        details.sort((a, b) => new Date(a.date) - new Date(b.date));

        let html = `<h2>${currentYear}å¹´${currentMonth}æœˆ åŠ ç­æ˜ç»†</h2>`;
        if (details.length === 0) {
          html += `<p>æœ¬æœˆæš‚æ— åŠ ç­è®°å½•ã€‚</p>`;
        } else {
          details.forEach(day => {
            html += `
              <p>
                <strong>${day.date} (${day.weekday})</strong><br>
                æ‰“å¡æ—¶é—´: ${day.times}<br>
                åŠ ç­æ—¶é•¿: ${day.durationStr}
              </p>
              <hr>
            `;
          });
          html += `<span class="total">æ€»åŠ ç­æ—¶é•¿: ${(totalSeconds / 3600).toFixed(2)} å°æ—¶</span>`;
        }

        document.getElementById('result').innerHTML = `<div class="result">${html}</div>`;

      } catch (err) {
        document.getElementById('result').innerHTML = 
          `<div class="result" style="color:#ff3b30;">âŒ è§£æå¤±è´¥ï¼š${err.message}</div>`;
      }
    }
  </script>
</body>
</html>
